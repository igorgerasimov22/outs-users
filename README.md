# Ansible Playbook для настройки пользователей
Этот Ansible Playbook предназначен для автоматизации процесса настройки пользователей на целевых хостах, определённых в инвентаре ```otus-users```. Он включает в себя создание групп, добавление пользователей, копирование скрипта для входа и конфигурации PAM.

## Содержание
* [Общее описание](#summary)
* [Структура Playbook](#structure)
* [Задачи](#tasks)
* [Как использовать](#use)

<a name="summary"></a> 

## Общее описаниеPlaybook выполняет следующие действия:

1. Обновляет кэш пакетов.
2. Создаёт группу ```admin```.
3. Добавляет пользователей ```otusadm``` и ```otus``` в систему с заданными параметрами.
4. Копирует скрипт для входа по SSH.
5. Копирует конфигурацию PAM для SSH.

<a name="structure"></a> 

## Структура Playbook
Playbook имеет следующую структуру:
```yaml
- name: Configure users
  hosts: otus-users
  become: true

  tasks:
    ...
```

<a name="tasks"></a> 

## Задачи
Каждая задача выполняется последовательно и имеет своё назначение:
**1. Обновление кэша пакетов**
```yaml
- name: Update cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
```
Эта задача обновляет кэш пакетов на целевых хостах, чтобы гарантировать, что все установленные пакеты будут последними доступными версиями.
**2. Создание группы ```admin```**
```yaml
- name: Create admin group
  ansible.builtin.group:
    name: admin
    state: present
    force: true
```
Эта задача создаёт группу ```admin```, если она ещё не существует. Параметр ```force: true``` позволяет обновить группу, если она уже существует.
**3. Добавление пользователя ```otusadm```**
```yaml
- name: User add otusadm
  ansible.builtin.user:
    name: otusadm
    shell: /bin/bash
    home: /home/otusadm
    password: '$1$K/SHbApt$AgZOjI1ww8Uc623MUWd7d.'
    groups: admin
```
Эта задача добавляет пользователя ```otusadm``` с домашним каталогом ```/home/otusadm```, оболочкой ```/bin/bash```, и устанавливает пароль.
**4. Добавление пользователя ```otus```**
```yaml
- name: User add otus
  ansible.builtin.user:
    name: otus
    shell: /bin/bash
    home: /home/otus
    password: '$1$K/SHbApt$AgZOjI1ww8Uc623MUWd7d.'
    groups: admin
```
Эта задача аналогична предыдущей, но создаёт пользователя ```otus```.
**5. Копирование скрипта для входа**
```yaml
- name: Copy login script
  ansible.builtin.copy:
    src: ~/ansible/outs-users/login.sh
    dest: /usr/local/bin/login.sh
    mode: '0777'
```
Эта задача копирует скрипт для входа в систему в каталог ```/usr/local/bin```, устанавливая права доступа ```0777```.
**6. Копирование конфигурации PAM**
```yaml
- name: Copy PAM config
  ansible.builtin.copy:
    src: ~/ansible/outs-users/sshd
    dest: /etc/pam.d/sshd
    owner: root
    group: root
    mode: '0644'
    remote_src: no
```
Эта задача копирует файл конфигурации PAM для SSH в соответствующий каталог, устанавливая владельца и права доступа.

<a name="use"></a> 

## Как использовать
1. Убедитесь, что у вас установлен ```Ansible```.
2. Настройте инвентарь, указав хосты, на которых будет выполняться Playbook. Например, в файле ```hosts```:
```ini
[otus-users]
user1.example.com
user2.example.com
```
3. Запустите Playbook с помощью команды:
```bash
ansible-playbook путь/к/playbook.yml
```
Где ```путь/к/playbook.yml``` — это путь к вашему Playbook.


# Скрипт для управления доступом пользователей по SSH в зависимости от дня недели
Этот скрипт написан на Bash и предназначен для управления доступом пользователей к системе через SSH в зависимости от дня недели. Он позволяет входить в систему только пользователям, принадлежащим к группе ```admin```, в выходные дни (суббота и воскресенье).

## Содержание
* [Общее описание](#summary)
* [Как работает скрипт](#HowTo)
* [Установка и использование](#use)
* [Логи](#logs)
* [Примечания](#primechaniya)

<a name="summary"></a> 

## Общее описание
Скрипт проверяет текущий день недели и определяет, является ли он выходным. Если день — это суббота или воскресенье, скрипт проверяет, принадлежит ли пользователь, пытающийся войти в систему, к группе ```admin```. Если пользователь не является её членом, доступ будет запрещён, и соответствующее сообщение будет записано в лог.

<a name="HowTo"></a> 

## Как работает скрипт

**1. Определение дня недели:**
```bash
bashDAY_OF_WEEK=$(date +%u)
```
Получает текущий день недели, где 1 — это понедельник, а 7 — воскресенье.
**2. Проверка выходных:**
```bash
bashif [ "$DAY_OF_WEEK" -eq 6 ] || [ "$DAY_OF_WEEK" -eq 7 ]; then
```
Проверяет, является ли текущий день выходным (суббота или воскресенье).
**3. Проверка группы пользователя:**
```bash
bashif ! id -nG "$PAM_USER" | grep -qw "admin"; then
```
Проверяет, принадлежит ли переменная ```$PAM_USER``` к группе ```admin```. Если нет, доступ будет запрещён.
**4. Запись в лог:**
```bash
bashecho "$(date): Access denied for user $PAM_USER on weekend" >> /var/log/login_attempts.log
```
Записывает сообщение об отказе в доступе в файл лога.
**5. Разрешение доступа:**
Если пользователь принадлежит к группе ```admin```, доступ разрешается, и соответствующее сообщение записывается в лог.

<a name="use"></a> 

## Установка и использование
**1. Создайте скрипт:**
Сохраните код в файле, например, ```/etc/security/pam_script.d/ssh_restrict.sh```.
**2. Сделайте скрипт исполняемым:**
```bash
bashsudo chmod +x /etc/security/pam_script.d/ssh_restrict.sh
```
**3. Настройте PAM:***
Добавьте строчку в файл ```/etc/pam.d/sshd````:
```bash
plaintextauth required pam_script.so
```
**4. Перезапустите SSH-сервер:**
После внесения изменений в конфигурацию PAM перезапустите SSH-сервер:
```bash
bashsudo systemctl restart sshd
```

<a name="logs"></a> 

## Логи
Все попытки входа записываются в файл ```/var/log/login_attempts.log```. Убедитесь, что у пользователя, под которым работает скрипт, есть права на запись в этот файл. Вы можете создать файл и установить к нему права:
```bash
bashsudo touch /var/log/login_attempts.log
sudo chmod 664 /var/log/login_attempts.log
sudo chown root:adm /var/log/login_attempts.log
```

<a name="primechaniya"></a>

## Примечания
Убедитесь, что группа ```admin``` существует на вашем сервере, и пользователи, которым нужен доступ, добавлены в эту группу.
Скрипт должен быть протестирован в безопасной среде перед использованием в производственной системе.